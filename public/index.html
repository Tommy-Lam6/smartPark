<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智慧停車場系統</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <!-- Leaflet 插件 -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol@0.76.0/dist/L.Control.Locate.min.css" />
    <script src="https://unpkg.com/leaflet.locatecontrol@0.76.0/dist/L.Control.Locate.min.js"></script>
   <h1>智慧停車場系統</h1> 
</head>
<body>
    <!-- 顶部导航栏 -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo" id="logo">
                    <i class="fas fa-parking"></i>
                    <h1>智慧<span>停车场</span></h1>
                </div>
                
                <nav>
                    <ul>
                        <li><a class="active" id="nav-home">首页</a></li>
                        <li><a id="nav-pricing">价格表</a></li>
                        <li><a id="nav-map">停车场地图</a></li>
                        <li><a id="nav-account">我的账户</a></li>
                        <li><a id="nav-credit">信用系统</a></li>
                    </ul>
                </nav>
                
                <div class="user-actions" id="user-actions">
                    <div class="credit-badge" id="credit-badge">
                        <i class="fas fa-star"></i>
                        <span>信用分: 92</span>
                    </div>
                    <button class="btn btn-outline" id="login-btn">
                        <i class="fas fa-sign-in-alt"></i>登录
                    </button>
                    <button class="btn btn-primary" id="register-btn">
                        <i class="fas fa-user-plus"></i>注册
                    </button>
                </div>
                
                <div class="user-profile" id="user-profile" style="display: none;">
                    <div class="user-avatar" id="user-avatar">U</div>
                    <span id="username-display">用户</span>
                    <div class="user-dropdown">
                        <a id="dropdown-account"><i class="fas fa-user"></i> 我的账户</a>
                        <a id="dropdown-history"><i class="fas fa-history"></i> 停车记录</a>
                        <a id="dropdown-payment"><i class="fas fa-credit-card"></i> 支付方式</a>
                        <a id="dropdown-logout"><i class="fas fa-sign-out-alt"></i> 退出登录</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- 主视觉区域 -->
    <section class="hero" id="hero-section">
        <div class="container">
            <div class="hero-content">
                <h2>智慧停车解决方案</h2>
                <p>查找附近停车场、预约车位、实时导航 - 让停车变得简单高效</p>
                <button class="btn btn-primary btn-large" id="locate-btn">
                    <i class="fas fa-map-marker-alt"></i>查找附近停车场
                </button>
            </div>
        </div>
    </section>

    <!-- Leaflet地图区域 -->
    <section class="map-section" id="map-section">
        <div class="container">
            <h2 class="section-title">停车场地图 <span class="live-indicator">实时更新 <i class="fas fa-circle"></i></span></h2>
            
            <div class="map-container">
                <div class="map-controls">
                    <div class="map-search">
                        <input type="text" id="search-input" placeholder="搜索地点或地址">
                        <button id="search-btn"><i class="fas fa-search"></i></button>
                    </div>
                    
                    <div class="map-filters">
                        <button class="map-filter active" data-filter="all">全部</button>
                        <button class="map-filter" data-filter="cheap">低价</button>
                        <button class="map-filter" data-filter="available">有空位</button>
                        <button class="map-filter" data-filter="electric">电动车</button>
                    </div>
                    
                    <div class="map-legend">
                        <div class="legend-item">
                            <div class="legend-icon current"><i class="fas fa-user"></i></div>
                            <span>您的位置</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-icon parking"><i class="fas fa-parking"></i></div>
                            <span>停车场</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-icon selected"><i class="fas fa-star"></i></div>
                            <span>精选停车场</span>
                        </div>
                    </div>
                </div>
                
                <div id="leaflet-map" class="leaflet-map"></div>
            </div>
        </div>
    </section>
    
    <!-- 用户仪表盘 -->
    <section class="dashboard" id="dashboard-section">
        <div class="container">
            <div class="dashboard-header">
                <h2>用户仪表盘</h2>
                <div class="credit-badge">
                    <i class="fas fa-star"></i>
                    <span id="dashboard-credit">信用分: 92</span>
                </div>
            </div>
            
            <div class="dashboard-cards">
                <div class="dashboard-card" id="current-parking-card">
                    <i class="fas fa-car"></i>
                    <h4>当前停车</h4>
                    <p id="current-parking-status">无</p>
                </div>
                <div class="dashboard-card">
                    <i class="fas fa-history"></i>
                    <h4>历史停车</h4>
                    <p id="history-count">24次</p>
                </div>
                <div class="dashboard-card">
                    <i class="fas fa-wallet"></i>
                    <h4>账户余额</h4>
                    <p id="account-balance">HK$ 320.50</p>
                </div>
                <div class="dashboard-card">
                    <i class="fas fa-star"></i>
                    <h4>信用等级</h4>
                    <p id="credit-level">黄金会员</p>
                </div>
            </div>
            
            <div class="recent-bookings">
                <h3>最近预约</h3>
                <div class="booking-list" id="booking-list">
                    <!-- 动态生成预约记录 -->
                </div>
            </div>
        </div>
    </section>
    
    <!-- 价格表区域 -->
    <section class="pricing-section" id="pricing-section">
        <div class="container">
            <h2>停车价格表</h2>
            <p>以下是各停车场的详细价格信息</p>
            
            <table class="pricing-table">
                <thead>
                    <tr>
                        <th>停车场名称</th>
                        <th>首小时</th>
                        <th>后续每小时</th>
                        <th>全日最高</th>
                        <th>电动车充电</th>
                    </tr>
                </thead>
                <tbody id="pricing-table-body">
                    <!-- 动态生成价格表 -->
                </tbody>
            </table>
        </div>
    </section>
    
    <!-- 信用系统区域 -->
    <section class="credit-section" id="credit-section">
        <div class="container">
            <h2>信用系统</h2>
            <p>良好的停车行为可以提升您的信用等级，享受更多优惠</p>
            
            <div class="credit-levels">
                <div class="credit-level basic">
                    <div class="level-icon"><i class="fas fa-star"></i></div>
                    <h4>基本会员</h4>
                    <p>信用分: 0-69</p>
                    <p>无特殊优惠</p>
                </div>
                <div class="credit-level silver">
                    <div class="level-icon"><i class="fas fa-star"></i></div>
                    <h4>白银会员</h4>
                    <p>信用分: 70-84</p>
                    <p>5%停车折扣</p>
                </div>
                <div class="credit-level gold">
                    <div class="level-icon"><i class="fas fa-star"></i></div>
                    <h4>黄金会员</h4>
                    <p>信用分: 85-94</p>
                    <p>10%停车折扣</p>
                    <p>优先车位</p>
                </div>
                <div class="credit-level platinum">
                    <div class="level-icon"><i class="fas fa-star"></i></div>
                    <h4>白金会员</h4>
                    <p>信用分: 95-100</p>
                    <p>15%停车折扣</p>
                    <p>专属车位</p>
                    <p>免费充电</p>
                </div>
            </div>
        </div>
    </section>

    <!-- 页脚 -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>关于我们</h3>
                    <p>智慧停车场管理系统致力于提供高效、智能的停车解决方案，让停车变得简单无忧。</p>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-facebook-f"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-linkedin-in"></i></a>
                    </div>
                </div>
                
                <div class="footer-section">
                    <h3>快速链接</h3>
                    <p><a href="#" id="footer-home"><i class="fas fa-home"></i> 首页</a></p>
                    <p><a href="#" id="footer-booking"><i class="fas fa-calendar-alt"></i> 预约车位</a></p>
                    <p><a href="#" id="footer-pricing"><i class="fas fa-tags"></i> 价格信息</a></p>
                    <p><a href="#" id="footer-map"><i class="fas fa-map"></i> 停车场地图</a></p>
                    <p><a href="#" id="footer-credit"><i class="fas fa-star"></i> 信用系统</a></p>
                </div>
                
                <div class="footer-section">
                    <h3>联系方式</h3>
                    <p><i class="fas fa-map-marker-alt"></i> 香港九龙观塘道888号</p>
                    <p><i class="fas fa-phone"></i> +852 1234 5678</p>
                    <p><i class="fas fa-envelope"></i> info@smartparking.hk</p>
                    <p><i class="fas fa-clock"></i> 24小时开放</p>
                </div>
            </div>
            
            <div class="copyright">
                <p>&copy; 2023 智慧停车场管理系统. 保留所有权利.</p>
                <p>地圖資料 © OpenStreetMap 貢獻者</p>
            </div>
        </div>
    </footer>
    
    <!-- 登录模态框 -->
    <div class="modal" id="login-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>用户登录</h3>
                <button class="close-modal" id="close-login">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>电子邮箱</label>
                    <input type="email" id="login-email" placeholder="输入您的邮箱">
                </div>
                <div class="form-group">
                    <label>密码</label>
                    <input type="password" id="login-password" placeholder="输入密码">
                </div>
                <div class="form-group">
                    <a href="#" id="forgot-password" style="color: var(--secondary);">忘记密码?</a>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-login">取消</button>
                <button class="btn btn-primary" id="submit-login">登录</button>
            </div>
        </div>
    </div>
    
    <!-- 注册模态框 -->
    <div class="modal" id="register-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>创建账户</h3>
                <button class="close-modal" id="close-register">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>姓名</label>
                    <input type="text" id="register-name" placeholder="输入您的姓名">
                </div>
                <div class="form-group">
                    <label>电子邮箱</label>
                    <input type="email" id="register-email" placeholder="输入您的邮箱">
                </div>
                <div class="form-group">
                    <label>手机号码</label>
                    <input type="tel" id="register-phone" placeholder="输入手机号码">
                </div>
                <div class="form-group">
                    <label>密码</label>
                    <input type="password" id="register-password" placeholder="设置密码">
                </div>
                <div class="form-group">
                    <label>确认密码</label>
                    <input type="password" id="register-confirm" placeholder="再次输入密码">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-register">取消</button>
                <button class="btn btn-primary" id="submit-register">注册</button>
            </div>
        </div>
    </div>
    
    <!-- 支付模态框 -->
    <div class="modal" id="payment-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>支付停车费</h3>
                <button class="close-modal" id="close-payment">&times;</button>
            </div>
            <div class="modal-body">
                <div class="payment-info">
                    <h4>停车信息</h4>
                    <p>停车场: <span id="payment-parking-name"></span></p>
                    <p>地址: <span id="payment-parking-address"></span></p>
                    <p>停车时长: <span id="payment-duration">3小时45分钟</span></p>
                    <p>总计: <span class="price" id="payment-total">HK$ 95.00</span></p>
                </div>
                
                <div class="payment-card">
                    <div class="payment-card-header">
                        <div class="card-type">VISA</div>
                        <div class="card-chip">
                            <i class="fas fa-microchip"></i>
                        </div>
                    </div>
                    <div class="card-number">•••• •••• •••• 1234</div>
                    <div class="card-details">
                        <div>
                            <label>持卡人姓名</label>
                            <span id="card-holder">WONG TAI MAN</span>
                        </div>
                        <div>
                            <label>有效期</label>
                            <span id="card-expiry">12/25</span>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>信用卡安全码 (CVV)</label>
                    <input type="password" id="card-cvv" placeholder="输入CVV" maxlength="3">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-payment">取消</button>
                <button class="btn btn-success" id="submit-payment">确认支付</button>
            </div>
        </div>
    </div>
    
    <!-- 支付成功模态框 -->
    <div class="modal" id="success-modal">
        <div class="modal-content">
            <div class="modal-header" style="background: var(--success);">
                <h3>支付成功!</h3>
                <button class="close-modal" id="close-success">&times;</button>
            </div>
            <div class="modal-body" style="text-align: center; padding: 40px 25px;">
                <div style="font-size: 5rem; color: var(--success); margin-bottom: 20px;">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h3 style="color: var(--dark); margin-bottom: 15px;">支付已完成</h3>
                <p style="color: var(--dark);">您的停车费用已成功支付</p>
                <p style="color: var(--dark);">感谢使用智慧停车系统</p>
                
                <div style="background: #f5f5f5; padding: 15px; border-radius: 10px; margin-top: 20px;">
                    <p>停车场: <span id="success-parking-name"></span></p>
                    <p>金额: <span class="price" id="success-amount">HK$ 95.00</span></p>
                    <p>交易号: <span id="success-transaction">PS202308150045</span></p>
                    <p>时间: <span id="success-time">2023-08-15 14:25:36</span></p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" style="width: 100%;" id="close-success-btn">完成</button>
            </div>
        </div>
    </div>
    
    <!-- 忘记密码模态框 -->
    <div class="modal" id="forgot-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>重置密码</h3>
                <button class="close-modal" id="close-forgot">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>电子邮箱</label>
                    <input type="email" id="forgot-email" placeholder="输入您的注册邮箱">
                </div>
                <p style="color: var(--dark); font-size: 0.9rem; margin-bottom: 20px;">
                    我们将发送重置密码链接到您的邮箱
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-forgot">取消</button>
                <button class="btn btn-primary" id="submit-forgot">发送重置链接</button>
            </div>
        </div>
    </div>
    
    <!-- 通知组件 -->
    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notification-message">操作成功</span>
    </div>

    <script>
        // 停车场数据
        const parkingData = [
            {
                id: 1,
                name: "九龙湾智能停车场",
                address: "九龙湾宏照道38号",
                position: [22.3235, 114.212],
                price: "HK$25/小时",
                available: 42,
                total: 120,
                electric: true,
                features: ["24小时开放", "电动车充电", "室内停车场"],
                rating: 4.5,
                pricing: {
                    firstHour: 25,
                    subsequent: 20,
                    maxDaily: 180,
                    chargingFee: 15
                }
            },
            {
                id: 2,
                name: "观塘海滨停车场",
                address: "观塘海滨道188号",
                position: [22.312, 114.225],
                price: "HK$20/小时",
                available: 18,
                total: 80,
                electric: true,
                features: ["海滨景观", "电动车充电", "保安监控"],
                rating: 4.2,
                pricing: {
                    firstHour: 20,
                    subsequent: 15,
                    maxDaily: 120,
                    chargingFee: 10
                }
            },
            {
                id: 3,
                name: "旺角中心停车场",
                address: "旺角弥敦道688号",
                position: [22.319, 114.172],
                price: "HK$30/小时",
                available: 5,
                total: 150,
                electric: false,
                features: ["市中心位置", "24小时保安", "多层停车场"],
                rating: 4.0,
                pricing: {
                    firstHour: 30,
                    subsequent: 25,
                    maxDaily: 200,
                    chargingFee: 0
                }
            },
            {
                id: 4,
                name: "尖沙咀星光停车场",
                address: "尖沙咀梳士巴利道3号",
                position: [22.295, 114.172],
                price: "HK$35/小时",
                available: 28,
                total: 200,
                electric: true,
                features: ["近购物中心", "电动车充电", "代客泊车"],
                rating: 4.7,
                pricing: {
                    firstHour: 35,
                    subsequent: 30,
                    maxDaily: 250,
                    chargingFee: 20
                }
            },
            {
                id: 5,
                name: "中环金融中心停车场",
                address: "中环金融街8号",
                position: [22.282, 114.158],
                price: "HK$40/小时",
                available: 12,
                total: 100,
                electric: true,
                features: ["商务区中心", "高级安保", "充电服务"],
                rating: 4.8,
                pricing: {
                    firstHour: 40,
                    subsequent: 35,
                    maxDaily: 300,
                    chargingFee: 25
                }
            }
        ];
        
        // 用户数据
        const users = [
            {
                id: 1,
                name: "黄先生",
                email: "user1@example.com",
                phone: "91234567",
                password: "password123",
                credit: 92,
                balance: 320.50,
                bookings: [
                    {
                        id: 101,
                        parkingId: 1,
                        date: "2023-08-10",
                        startTime: "14:30",
                        endTime: "18:45",
                        duration: "4小时15分钟",
                        fee: 85.00,
                        status: "completed"
                    },
                    {
                        id: 102,
                        parkingId: 2,
                        date: "2023-08-08",
                        startTime: "10:15",
                        endTime: "16:20",
                        duration: "6小时5分钟",
                        fee: 110.00,
                        status: "completed"
                    }
                ]
            }
        ];
        
        // 当前用户状态
        let currentUser = null;
        let currentBooking = null;
        let currentParking = null;
        
        // 预约数据
        let bookings = [];
        
        // Leaflet地图相关变量
        let map;
        let userMarker;
        let parkingMarkers = [];
        let currentPopup = null;
        let locateControl;
        
        // DOM元素
        const elements = {
            // 导航栏
            navHome: document.getElementById('nav-home'),
            navPricing: document.getElementById('nav-pricing'),
            navMap: document.getElementById('nav-map'),
            navAccount: document.getElementById('nav-account'),
            navCredit: document.getElementById('nav-credit'),
            
            // 用户相关
            userActions: document.getElementById('user-actions'),
            userProfile: document.getElementById('user-profile'),
            userAvatar: document.getElementById('user-avatar'),
            usernameDisplay: document.getElementById('username-display'),
            creditBadge: document.getElementById('credit-badge'),
            dashboardCredit: document.getElementById('dashboard-credit'),
            
            // 按钮
            loginBtn: document.getElementById('login-btn'),
            registerBtn: document.getElementById('register-btn'),
            locateBtn: document.getElementById('locate-btn'),
            searchBtn: document.getElementById('search-btn'),
            
            // 下拉菜单
            dropdownAccount: document.getElementById('dropdown-account'),
            dropdownHistory: document.getElementById('dropdown-history'),
            dropdownPayment: document.getElementById('dropdown-payment'),
            dropdownLogout: document.getElementById('dropdown-logout'),
            
            // 页面区块
            heroSection: document.getElementById('hero-section'),
            mapSection: document.getElementById('map-section'),
            dashboardSection: document.getElementById('dashboard-section'),
            pricingSection: document.getElementById('pricing-section'),
            creditSection: document.getElementById('credit-section'),
            
            // 仪表盘
            currentParkingStatus: document.getElementById('current-parking-status'),
            historyCount: document.getElementById('history-count'),
            accountBalance: document.getElementById('account-balance'),
            creditLevel: document.getElementById('credit-level'),
            bookingList: document.getElementById('booking-list'),
            
            // 价格表
            pricingTableBody: document.getElementById('pricing-table-body'),
            
            // 模态框
            loginModal: document.getElementById('login-modal'),
            registerModal: document.getElementById('register-modal'),
            paymentModal: document.getElementById('payment-modal'),
            successModal: document.getElementById('success-modal'),
            forgotModal: document.getElementById('forgot-modal'),
            
            // 登录/注册表单
            loginEmail: document.getElementById('login-email'),
            loginPassword: document.getElementById('login-password'),
            registerName: document.getElementById('register-name'),
            registerEmail: document.getElementById('register-email'),
            registerPhone: document.getElementById('register-phone'),
            registerPassword: document.getElementById('register-password'),
            registerConfirm: document.getElementById('register-confirm'),
            forgotEmail: document.getElementById('forgot-email'),
            
            // 支付表单
            paymentParkingName: document.getElementById('payment-parking-name'),
            paymentParkingAddress: document.getElementById('payment-parking-address'),
            paymentTotal: document.getElementById('payment-total'),
            cardCvv: document.getElementById('card-cvv'),
            
            // 成功页面
            successParkingName: document.getElementById('success-parking-name'),
            successAmount: document.getElementById('success-amount'),
            
            // 关闭按钮
            closeLogin: document.getElementById('close-login'),
            closeRegister: document.getElementById('close-register'),
            closePayment: document.getElementById('close-payment'),
            closeSuccess: document.getElementById('close-success'),
            closeForgot: document.getElementById('close-forgot'),
            cancelLogin: document.getElementById('cancel-login'),
            cancelRegister: document.getElementById('cancel-register'),
            cancelPayment: document.getElementById('cancel-payment'),
            cancelForgot: document.getElementById('cancel-forgot'),
            closeSuccessBtn: document.getElementById('close-success-btn'),
            
            // 提交按钮
            submitLogin: document.getElementById('submit-login'),
            submitRegister: document.getElementById('submit-register'),
            submitPayment: document.getElementById('submit-payment'),
            submitForgot: document.getElementById('submit-forgot'),
            
            // 其他
            forgotPassword: document.getElementById('forgot-password'),
            searchInput: document.getElementById('search-input'),
            mapFilters: document.querySelectorAll('.map-filter'),
            footerHome: document.getElementById('footer-home'),
            footerBooking: document.getElementById('footer-booking'),
            footerPricing: document.getElementById('footer-pricing'),
            footerMap: document.getElementById('footer-map'),
            footerCredit: document.getElementById('footer-credit'),
            
            // 通知
            notification: document.getElementById('notification'),
            notificationMessage: document.getElementById('notification-message')
        };
        
        // 初始化函数
        function init() {
            // 检查本地存储中是否有登录用户
            const storedUser = localStorage.getItem('parkingUser');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                updateUserUI();
            }
            
            // 初始化地图
            initMap();
            
            // 初始化价格表
            initPricingTable();
            
            // 初始化事件监听器
            initEventListeners();
            
            // 启动实时车位更新
            startRealTimeUpdates();
        }
        
        // 初始化地图
        function initMap() {
            // 默认以香港为中心
            const hongKong = [22.3193, 114.1694];
            
            // 创建地图
            map = L.map('leaflet-map', {
                zoomControl: false
            }).setView(hongKong, 12);
            
            // 添加OpenStreetMap图层
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(map);
            
            // 添加缩放控件
            L.control.zoom({
                position: 'topright'
            }).addTo(map);
            
            // 添加定位控件
            locateControl = L.control.locate({
                position: 'topright',
                strings: {
                    title: "定位我的位置",
                    popup: "您的位置"
                },
                locateOptions: {
                    maxZoom: 15
                }
            }).addTo(map);
            
            // 添加停车场标记
            addParkingMarkers();
        }
        
        // 添加停车场标记
        function addParkingMarkers() {
            // 清除现有标记
            parkingMarkers.forEach(marker => map.removeLayer(marker));
            parkingMarkers = [];
            
            // 添加新标记
            parkingData.forEach(parking => {
                // 根据空位数量确定颜色
                const availabilityClass = getAvailabilityClass(parking.available, parking.total);
                
                // 创建自定义图标
                const icon = L.divIcon({
                    html: `<div style="background: ${parking.available > 10 ? '#2ecc71' : '#e74c3c'};
                            width: 40px; 
                            height: 40px; 
                            border-radius: 50%; 
                            display: flex; 
                            align-items: center; 
                            justify-content: center;
                            color: white;
                            font-size: 20px;
                            border: 2px solid white;
                            box-shadow: 0 0 10px rgba(0,0,0,0.3);">
                          <i class="fas fa-parking"></i>
                        </div>`,
                    className: '',
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });
                
                // 创建标记
                const marker = L.marker(parking.position, { 
                    icon: icon,
                    parkingId: parking.id
                }).addTo(map);
                
                // 添加点击事件
                marker.on('click', function(e) {
                    // 关闭当前打开的弹窗
                    if (currentPopup) {
                        currentPopup.closePopup();
                    }
                    
                    const parking = parkingData.find(p => p.id === e.target.options.parkingId);
                    if (parking) {
                        currentParking = parking;
                        
                        const availabilityClass = getAvailabilityClass(parking.available, parking.total);
                        
                        const content = `
                            <div class="parking-card">
                                <h3>${parking.name}</h3>
                                <p><i class="fas fa-map-marker-alt"></i> ${parking.address}</p>
                                <p><i class="fas fa-tag"></i> ${parking.price}</p>
                                <p><i class="fas fa-car"></i> 空位: 
                                    <span class="availability ${availabilityClass}">
                                        ${parking.available}/${parking.total}
                                    </span>
                                </p>
                                <p><i class="fas fa-star"></i> 评分: ${parking.rating}/5.0</p>
                                <p class="price">${parking.features.join(" · ")}</p>
                                <button class="btn btn-primary" onclick="reserveParking(${parking.id})">
                                    <i class="fas fa-calendar-check"></i> 预约车位
                                </button>
                            </div>
                        `;
                        
                        const popup = L.popup()
                            .setLatLng(parking.position)
                            .setContent(content)
                            .openOn(map);
                        
                        currentPopup = popup;
                    }
                });
                
                parkingMarkers.push(marker);
            });
        }
        
        // 获取空位状态类
        function getAvailabilityClass(available, total) {
            if (available / total > 0.3) return 'high';
            if (available / total > 0.1) return 'medium';
            return 'low';
        }
        
        // 初始化价格表
        function initPricingTable() {
            const tableBody = elements.pricingTableBody;
            tableBody.innerHTML = '';
            
            parkingData.forEach(parking => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${parking.name}</td>
                    <td>HK$ ${parking.pricing.firstHour}</td>
                    <td>HK$ ${parking.pricing.subsequent}</td>
                    <td>HK$ ${parking.pricing.maxDaily}</td>
                    <td>${parking.electric ? `HK$ ${parking.pricing.chargingFee}/小时` : '不提供'}</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // 初始化事件监听器
        function initEventListeners() {
            // 导航菜单
            elements.navHome.addEventListener('click', () => showSection('home'));
            elements.navPricing.addEventListener('click', () => showSection('pricing'));
            elements.navMap.addEventListener('click', () => showSection('map'));
            elements.navAccount.addEventListener('click', () => showSection('account'));
            elements.navCredit.addEventListener('click', () => showSection('credit'));
            
            // 页脚导航
            elements.footerHome.addEventListener('click', () => showSection('home'));
            elements.footerBooking.addEventListener('click', () => showSection('account'));
            elements.footerPricing.addEventListener('click', () => showSection('pricing'));
            elements.footerMap.addEventListener('click', () => showSection('map'));
            elements.footerCredit.addEventListener('click', () => showSection('credit'));
            
            // 用户操作
            elements.loginBtn.addEventListener('click', () => openModal('login'));
            elements.registerBtn.addEventListener('click', () => openModal('register'));
            elements.dropdownAccount.addEventListener('click', () => showSection('account'));
            elements.dropdownHistory.addEventListener('click', () => showSection('account'));
            elements.dropdownPayment.addEventListener('click', () => openModal('payment'));
            elements.dropdownLogout.addEventListener('click', logout);
            
            // 定位按钮
            elements.locateBtn.addEventListener('click', () => locateControl.start());
            
            // 搜索按钮
            elements.searchBtn.addEventListener('click', searchLocation);
            
            // 过滤器按钮
            elements.mapFilters.forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.map-filter').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    filterParking(this.dataset.filter);
                });
            });
            
            // 模态框关闭按钮
            elements.closeLogin.addEventListener('click', () => closeModal('login'));
            elements.closeRegister.addEventListener('click', () => closeModal('register'));
            elements.closePayment.addEventListener('click', () => closeModal('payment'));
            elements.closeSuccess.addEventListener('click', () => closeModal('success'));
            elements.closeForgot.addEventListener('click', () => closeModal('forgot'));
            elements.cancelLogin.addEventListener('click', () => closeModal('login'));
            elements.cancelRegister.addEventListener('click', () => closeModal('register'));
            elements.cancelPayment.addEventListener('click', () => closeModal('payment'));
            elements.cancelForgot.addEventListener('click', () => closeModal('forgot'));
            elements.closeSuccessBtn.addEventListener('click', () => closeModal('success'));
            
            // 表单提交
            elements.submitLogin.addEventListener('click', login);
            elements.submitRegister.addEventListener('click', register);
            elements.submitPayment.addEventListener('click', completePayment);
            elements.submitForgot.addEventListener('click', submitForgotPassword);
            
            // 忘记密码
            elements.forgotPassword.addEventListener('click', () => {
                closeModal('login');
                openModal('forgot');
            });
        }
        
        // 显示特定区块
        function showSection(section) {
            // 隐藏所有区块
            elements.heroSection.style.display = 'none';
            elements.mapSection.style.display = 'none';
            elements.dashboardSection.style.display = 'none';
            elements.pricingSection.style.display = 'none';
            elements.creditSection.style.display = 'none';
            
            // 更新导航菜单激活状态
            document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
            
            // 显示选定的区块
            switch(section) {
                case 'home':
                    elements.heroSection.style.display = 'block';
                    elements.mapSection.style.display = 'block';
                    elements.navHome.classList.add('active');
                    break;
                case 'pricing':
                    elements.pricingSection.style.display = 'block';
                    elements.navPricing.classList.add('active');
                    break;
                case 'map':
                    elements.mapSection.style.display = 'block';
                    elements.navMap.classList.add('active');
                    break;
                case 'account':
                    if (!currentUser) {
                        showNotification('请先登录', 'error');
                        openModal('login');
                        return;
                    }
                    elements.dashboardSection.style.display = 'block';
                    elements.navAccount.classList.add('active');
                    updateDashboard();
                    break;
                case 'credit':
                    elements.creditSection.style.display = 'block';
                    elements.navCredit.classList.add('active');
                    break;
            }
        }
        
        // 更新用户界面
        function updateUserUI() {
            if (currentUser) {
                elements.userActions.style.display = 'none';
                elements.userProfile.style.display = 'flex';
                elements.userAvatar.textContent = currentUser.name.charAt(0);
                elements.usernameDisplay.textContent = currentUser.name;
                elements.creditBadge.innerHTML = `<i class="fas fa-star"></i><span>信用分: ${currentUser.credit}</span>`;
                elements.dashboardCredit.textContent = `信用分: ${currentUser.credit}`;
            } else {
                elements.userActions.style.display = 'flex';
                elements.userProfile.style.display = 'none';
            }
        }
        
        // 更新仪表盘
        function updateDashboard() {
            if (!currentUser) return;
            
            // 更新当前停车状态
            if (currentBooking) {
                elements.currentParkingStatus.textContent = '进行中';
            } else {
                elements.currentParkingStatus.textContent = '无';
            }
            
            // 更新历史记录计数
            elements.historyCount.textContent = `${currentUser.bookings.length}次`;
            
            // 更新账户余额
            elements.accountBalance.textContent = `HK$ ${currentUser.balance.toFixed(2)}`;
            
            // 更新信用等级
            let level = '基本会员';
            if (currentUser.credit >= 95) level = '白金会员';
            else if (currentUser.credit >= 85) level = '黄金会员';
            else if (currentUser.credit >= 70) level = '白银会员';
            elements.creditLevel.textContent = level;
            
            // 更新预约列表
            updateBookingList();
        }
        
        // 更新预约列表
        function updateBookingList() {
            const bookingList = elements.bookingList;
            bookingList.innerHTML = '';
            
            // 添加当前预约
            if (currentBooking) {
                const parking = parkingData.find(p => p.id === currentBooking.parkingId);
                if (parking) {
                    const item = document.createElement('div');
                    item.className = 'booking-item';
                    item.innerHTML = `
                        <div class="booking-details">
                            <h4>${parking.name}</h4>
                            <p>${currentBooking.time}</p>
                            <p>预计费用: ${parking.price}</p>
                        </div>
                        <div class="booking-status status-active">进行中</div>
                    `;
                    bookingList.appendChild(item);
                }
            }
            
            // 添加历史预约
            currentUser.bookings.forEach(booking => {
                const parking = parkingData.find(p => p.id === booking.parkingId);
                if (parking) {
                    const item = document.createElement('div');
                    item.className = 'booking-item';
                    
                    let statusClass = 'status-completed';
                    if (booking.status === 'cancelled') statusClass = 'status-cancelled';
                    
                    item.innerHTML = `
                        <div class="booking-details">
                            <h4>${parking.name}</h4>
                            <p>${booking.date} ${booking.startTime} - ${booking.endTime}</p>
                            <p>总费用: HK$ ${booking.fee.toFixed(2)}</p>
                        </div>
                        <div class="booking-status ${statusClass}">${booking.status === 'cancelled' ? '已取消' : '已完成'}</div>
                    `;
                    bookingList.appendChild(item);
                }
            });
        }
        
        // 过滤停车场
        function filterParking(filterType) {
            parkingMarkers.forEach(marker => {
                const parkingId = marker.options.parkingId;
                const parking = parkingData.find(p => p.id === parkingId);
                
                let show = true;
                
                switch(filterType) {
                    case 'cheap':
                        const price = parseFloat(parking.price.replace('HK$', ''));
                        show = price <= 25;
                        break;
                    case 'available':
                        show = parking.available > 10;
                        break;
                    case 'electric':
                        show = parking.electric;
                        break;
                }
                
                if (show) {
                    map.addLayer(marker);
                } else {
                    map.removeLayer(marker);
                }
            });
        }
        
        // 搜索地点
        function searchLocation() {
            const input = elements.searchInput.value;
            if (!input) return;
            
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(input)}&limit=1`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        const result = data[0];
                        const lat = parseFloat(result.lat);
                        const lon = parseFloat(result.lon);
                        
                        map.setView([lat, lon], 15);
                        
                        // 添加标记
                        L.marker([lat, lon], {
                            icon: L.divIcon({
                                html: `<div style="background: #3498db;
                                        width: 40px; 
                                        height: 40px; 
                                        border-radius: 50%; 
                                        display: flex; 
                                        align-items: center; 
                                        justify-content: center;
                                        color: white;
                                        font-size: 20px;
                                        border: 2px solid white;
                                        box-shadow: 0 0 10px rgba(0,0,0,0.3);">
                                      <i class="fas fa-search"></i>
                                    </div>`,
                                className: '',
                                iconSize: [40, 40],
                                iconAnchor: [20, 20]
                            })
                        })
                        .addTo(map)
                        .bindPopup(`<b>${result.display_name}</b>`)
                        .openPopup();
                    } else {
                        showNotification(`无法找到该地点: ${input}`, 'error');
                    }
                })
                .catch(error => {
                    console.error('搜索错误:', error);
                    showNotification("搜索过程中发生错误", 'error');
                });
        }
        
        // 预约停车场
        function reserveParking(id) {
            const parking = parkingData.find(p => p.id === id);
            if (parking) {
                if (!currentUser) {
                    showNotification("请先登录以预约车位", 'error');
                    openModal('login');
                    return;
                }
                
                if (parking.available <= 0) {
                    showNotification("该停车场已无空位", 'error');
                    return;
                }
                
                // 减少一个空位（模拟）
                parking.available--;
                
                // 更新地图标记
                addParkingMarkers();
                
                // 创建当前预约
                const now = new Date();
                const date = now.toISOString().split('T')[0];
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                
                currentBooking = {
                    id: Date.now(),
                    parkingId: id,
                    name: parking.name,
                    time: `${date} ${hours}:${minutes}`,
                    price: parking.price,
                    startTime: now.getTime()
                };
                
                showNotification(`已预约 ${parking.name} 的车位`, 'success');
                updateDashboard();
                
                if (currentPopup) {
                    currentPopup.closePopup();
                }
            }
        }
        
        // 打开模态框
        function openModal(type) {
            document.getElementById(`${type}-modal`).classList.add('active');
        }
        
        // 关闭模态框
        function closeModal(type) {
            document.getElementById(`${type}-modal`).classList.remove('active');
            
            // 清除表单
            if (type === 'login') {
                elements.loginEmail.value = '';
                elements.loginPassword.value = '';
            } else if (type === 'register') {
                elements.registerName.value = '';
                elements.registerEmail.value = '';
                elements.registerPhone.value = '';
                elements.registerPassword.value = '';
                elements.registerConfirm.value = '';
            } else if (type === 'payment') {
                elements.cardCvv.value = '';
            } else if (type === 'forgot') {
                elements.forgotEmail.value = '';
            }
        }
        
        // 用户登录
        function login() {
            const email = elements.loginEmail.value;
            const password = elements.loginPassword.value;
            
            if (!email || !password) {
                showNotification("请输入邮箱和密码", 'error');
                return;
            }
            
            // 查找用户
            const user = users.find(u => u.email === email && u.password === password);
            if (user) {
                currentUser = {...user};
                localStorage.setItem('parkingUser', JSON.stringify(currentUser));
                updateUserUI();
                closeModal('login');
                showNotification("登录成功！", 'success');
                showSection('account');
            } else {
                showNotification("邮箱或密码错误", 'error');
            }
        }
        
        // 用户注册
        function register() {
            const name = elements.registerName.value;
            const email = elements.registerEmail.value;
            const phone = elements.registerPhone.value;
            const password = elements.registerPassword.value;
            const confirm = elements.registerConfirm.value;
            
            if (!name || !email || !phone || !password || !confirm) {
                showNotification("请填写所有必填字段", 'error');
                return;
            }
            
            if (password !== confirm) {
                showNotification("两次输入的密码不一致", 'error');
                return;
            }
            
            // 检查邮箱是否已注册
            if (users.some(u => u.email === email)) {
                showNotification("该邮箱已被注册", 'error');
                return;
            }
            
            // 创建新用户
            const newUser = {
                id: users.length + 1,
                name,
                email,
                phone,
                password,
                credit: 85,
                balance: 0,
                bookings: []
            };
            
            users.push(newUser);
            currentUser = {...newUser};
            localStorage.setItem('parkingUser', JSON.stringify(currentUser));
            updateUserUI();
            closeModal('register');
            showNotification("注册成功！", 'success');
            showSection('account');
        }
        
        // 退出登录
        function logout() {
            currentUser = null;
            currentBooking = null;
            localStorage.removeItem('parkingUser');
            showSection('home');
            showNotification("您已成功退出登录", 'success');
            updateUserUI();
        }
        
        // 完成支付
        function completePayment() {
            if (!currentBooking || !currentUser) {
                showNotification("没有需要支付的停车", 'error');
                return;
            }
            
            const cvv = elements.cardCvv.value;
            if (!cvv || cvv.length !== 3) {
                showNotification("请输入有效的CVV码", 'error');
                return;
            }
            
            // 计算停车费用
            const parking = parkingData.find(p => p.id === currentBooking.parkingId);
            if (!parking) {
                showNotification("停车场信息错误", 'error');
                return;
            }
            
            const now = new Date();
            const durationMs = now.getTime() - currentBooking.startTime;
            const durationHours = Math.ceil(durationMs / (1000 * 60 * 60));
            
            let fee = parking.pricing.firstHour;
            if (durationHours > 1) {
                fee += (durationHours - 1) * parking.pricing.subsequent;
            }
            
            // 应用信用折扣
            let discount = 0;
            if (currentUser.credit >= 95) discount = 0.15;
            else if (currentUser.credit >= 85) discount = 0.1;
            else if (currentUser.credit >= 70) discount = 0.05;
            
            const discountedFee = fee * (1 - discount);
            
            // 更新用户余额
            currentUser.balance -= discountedFee;
            
            // 创建停车记录
            const endTime = new Date();
            const startTime = new Date(currentBooking.startTime);
            
            const bookingRecord = {
                id: currentBooking.id,
                parkingId: currentBooking.parkingId,
                date: startTime.toISOString().split('T')[0],
                startTime: `${startTime.getHours().toString().padStart(2, '0')}:${startTime.getMinutes().toString().padStart(2, '0')}`,
                endTime: `${endTime.getHours().toString().padStart(2, '0')}:${endTime.getMinutes().toString().padStart(2, '0')}`,
                duration: `${durationHours}小时`,
                fee: discountedFee,
                status: 'completed'
            };
            
            currentUser.bookings.unshift(bookingRecord);
            localStorage.setItem('parkingUser', JSON.stringify(currentUser));
            
            // 更新支付成功模态框内容
            elements.successParkingName.textContent = parking.name;
            elements.successAmount.textContent = `HK$ ${discountedFee.toFixed(2)}`;
            
            // 生成随机交易号
            const transactionId = `PS${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}${Math.floor(Math.random() * 10000).toString().padStart(4, '0')}`;
            elements.successTransaction.textContent = transactionId;
            
            // 格式化时间
            const formattedTime = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            elements.successTime.textContent = formattedTime;
            
            // 关闭支付模态框，打开成功模态框
            closeModal('payment');
            openModal('success');
            
            // 重置当前预约
            currentBooking = null;
            updateDashboard();
        }
        
        // 提交忘记密码请求
        function submitForgotPassword() {
            const email = elements.forgotEmail.value;
            
            if (!email) {
                showNotification("请输入注册邮箱", 'error');
                return;
            }
            
            // 模拟发送重置链接
            setTimeout(() => {
                closeModal('forgot');
                showNotification("重置链接已发送到您的邮箱", 'success');
            }, 1000);
        }
        
        // 显示通知
        function showNotification(message, type = 'success') {
            const notification = elements.notification;
            const notificationMessage = elements.notificationMessage;
            
            notification.className = 'notification';
            notification.classList.add(type);
            notificationMessage.textContent = message;
            
            notification.classList.add('active');
            
            // 3秒后自动隐藏
            setTimeout(() => {
                notification.classList.remove('active');
            }, 3000);
        }
        
        // 启动实时车位更新
        function startRealTimeUpdates() {
            // 每30秒更新一次车位信息
            setInterval(() => {
                parkingData.forEach(parking => {
                    // 模拟车位变化（±3个车位）
                    const change = Math.floor(Math.random() * 7) - 3;
                    parking.available = Math.max(0, Math.min(parking.total, parking.available + change));
                });
                
                // 更新地图标记
                addParkingMarkers();
                
                // 如果有打开的弹出窗口，也更新它
                if (currentPopup && currentPopup.isOpen()) {
                    const parkingId = currentPopup._source.options.parkingId;
                    const parking = parkingData.find(p => p.id === parkingId);
                    
                    if (parking) {
                        const availabilityClass = getAvailabilityClass(parking.available, parking.total);
                        
                        const content = `
                            <div class="parking-card">
                                <h3>${parking.name}</h3>
                                <p><i class="fas fa-map-marker-alt"></i> ${parking.address}</p>
                                <p><i class="fas fa-tag"></i> ${parking.price}</p>
                                <p><i class="fas fa-car"></i> 空位: 
                                    <span class="availability ${availabilityClass}">
                                        ${parking.available}/${parking.total}
                                    </span>
                                </p>
                                <p><i class="fas fa-star"></i> 评分: ${parking.rating}/5.0</p>
                                <p class="price">${parking.features.join(" · ")}</p>
                                <button class="btn btn-primary" onclick="reserveParking(${parking.id})">
                                    <i class="fas fa-calendar-check"></i> 预约车位
                                </button>
                            </div>
                        `;
                        
                        currentPopup.setContent(content);
                    }
                }
            }, 30000);
        }
        
        // 初始化应用
        document.addEventListener('DOMContentLoaded', init);
    </script>
    <h3>前往會員登記及登錄頁</h3><a href="../private/login.html">點擊這裡</a>
</body>
</html>